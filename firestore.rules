/**
 * @file Firebase Security Rules for SpaceWise Application
 * @core_philosophy This ruleset enforces a strict hierarchical ownership model based on Firestore paths.
 *  Each level of the hierarchy (locations, rooms, beds, occupants, bookings) is nested under the previous one.
 *  All data access is restricted based on the ID of the parent document in the path. This approach avoids costly
 *  `get()` calls and simplifies the rules, improving performance and security.
 * @data_structure The data is structured hierarchically: /locations/{locationId}/rooms/{roomId}/beds/{bedId}/occupants/{occupantId} and bookings.
 * @key_security_decisions All collections use strict path-based authorization. There is no public access. All write operations require a valid authenticated user. List operations are allowed to all authenticated users.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Controls access to the /locations/{locationId} collection.
     * @path /locations/{locationId}
     * @allow (create, update, delete) - Only an authenticated user can create a location. The document ID must match the `locationId` path segment.
     * @allow (get, list) - Only an authenticated user can get and list locations.
     * @deny (create, update, delete) - A non-authenticated user cannot create, update or delete a location.
     * @principle Enforces that only authenticated users can create, update, delete and list locations.
     */
    match /locations/{locationId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn() && request.resource.data.id == locationId;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to the /locations/{locationId}/rooms/{roomId} collection.
     * @path /locations/{locationId}/rooms/{roomId}
     * @allow (create, update, delete) - Only an authenticated user can create a room within a location.
     * @allow (get, list) - Only an authenticated user can get and list rooms.
     * @deny (create, update, delete) - A non-authenticated user cannot create, update or delete a room.
     * @principle Enforces that only authenticated users can create, update, delete and list rooms.
     */
    match /locations/{locationId}/rooms/{roomId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn() ;
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to the collection group 'beds'.
     * @path /locations/{locationId}/rooms/{roomId}/beds/{bedId}
     * @allow (list) - Allows authenticated users to list all beds across all rooms and locations.
     * @principle This is necessary for the collection group query used to get all beds for a location.
     */
    match /{path=**}/beds/{bedId} {
        allow list: if request.auth != null;
    }

    /**
     * @description Controls access to the /locations/{locationId}/rooms/{roomId}/beds/{bedId} collection.
     * @path /locations/{locationId}/rooms/{roomId}/beds/{bedId}
     * @allow (create, update, delete) - Only an authenticated user can create a bed within a room.
     * @allow (get) - Only an authenticated user can get a specific bed.
     * @deny (create, update, delete) - A non-authenticated user cannot create, update or delete a bed.
     * @principle Enforces that only authenticated users can manage and view individual beds.
     */
    match /locations/{locationId}/rooms/{roomId}/beds/{bedId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to the /locations/{locationId}/rooms/{roomId}/beds/{bedId}/occupants/{occupantId} collection.
     * @path /locations/{locationId}/rooms/{roomId}/beds/{bedId}/occupants/{occupantId}
     * @allow (create, update, delete) - Only an authenticated user can create an occupant for a bed.
     * @allow (get, list) - Only an authenticated user can get and list occupants.
     * @deny (create, update, delete) - A non-authenticated user cannot create, update or delete an occupant.
     * @principle Enforces that only authenticated users can create, update, delete and list occupants.
     */
    match /locations/{locationId}/rooms/{roomId}/beds/{bedId}/occupants/{occupantId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }

    /**
     * @description Controls access to the /locations/{locationId}/rooms/{roomId}/beds/{bedId}/bookings/{bookingId} collection.
     * @path /locations/{locationId}/rooms/{roomId}/beds/{bedId}/bookings/{bookingId}
     * @allow (create, update, delete) - Only an authenticated user can create a booking for a bed.
     * @allow (get, list) - Only an authenticated user can get and list bookings.
     * @deny (create, update, delete) - A non-authenticated user cannot create, update or delete a booking.
     * @principle Enforces that only authenticated users can create, update, delete and list bookings.
     */
    match /locations/{locationId}/rooms/{roomId}/beds/{bedId}/bookings/{bookingId} {
      function isSignedIn() {
        return request.auth != null;
      }

      allow get, list: if isSignedIn();
      allow create: if isSignedIn();
      allow update: if isSignedIn();
      allow delete: if isSignedIn();
    }
  }
}
