/**
 * @file Overview
 * This ruleset enforces a strict user-ownership model for bookings,
 * and a public-read, owner-write model for locations, rooms, and beds.
 *
 * Data Structure:
 * - /locations/{locationId}: Stores location data. Publicly readable.
 * - /locations/{locationId}/rooms/{roomId}: Stores room data. Publicly readable.
 * - /locations/{locationId}/rooms/{roomId}/beds/{bedId}: Stores bed data. Publicly readable.
 * - /users/{userId}: Stores user profile data. Owner-only access.
 * - /users/{userId}/bookings/{bookingId}: Stores booking data. Owner-only access.
 *
 * Key Security Decisions:
 * - Users can only manage their own bookings and profile data.
 * - Locations, rooms, and beds are publicly readable, but writes are not currently secured (TODO: add admin role).
 * - Listing of all bookings is restricted to the owner.
 *
 * Denormalization for Authorization:
 * - Location, Room, and Bed documents will contain fields like `locationId` and `roomId` to simplify
 *   authorization checks in subcollections, though this is not currently used, as writes are not secured.
 *
 * Structural Segregation:
 * - Bookings are stored under a user's path (/users/{userId}/bookings/{bookingId}) to ensure
 *   strict ownership and prevent unauthorized access.
 */
rules_version = '2';
service cloud.firestore {
  match /databases/{database}/documents {

    /**
     * @description Allows anyone to read locations, but restricts write access.
     * @path /locations/{locationId}
     * @allow (get, list): Any user can read location data.
     * @deny (create, update, delete): No one can create, update, or delete locations without proper authorization (TODO: Add admin role).
     * @principle Allows public read access for locations; requires authorization for writes (TODO).
     */
    match /locations/{locationId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows anyone to read rooms, but restricts write access.
     * @path /locations/{locationId}/rooms/{roomId}
     * @allow (get, list): Any user can read room data.
     * @deny (create, update, delete): No one can create, update, or delete rooms without proper authorization (TODO: Add admin role).
     * @principle Allows public read access for rooms; requires authorization for writes (TODO).
     */
    match /locations/{locationId}/rooms/{roomId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Allows anyone to read beds, but restricts write access.
     * @path /locations/{locationId}/rooms/{roomId}/beds/{bedId}
     * @allow (get, list): Any user can read bed data.
     * @deny (create, update, delete): No one can create, update, or delete beds without proper authorization (TODO: Add admin role).
     * @principle Allows public read access for beds; requires authorization for writes (TODO).
     */
    match /locations/{locationId}/rooms/{roomId}/beds/{bedId} {
      allow get, list: if true;
      allow create, update, delete: if false; // TODO: Add owner validation once the schema is updated with an ownership field.
    }

    /**
     * @description Manages user profile data, ensuring only the user can access their own profile.
     * @path /users/{userId}
     * @allow (get, update, delete): User can access and modify their own profile.
     * @allow (create): User can create their own profile if the userId matches their auth UID.
     * @deny (list): Prevents listing all users.
     * @principle Enforces document ownership for user profiles.
     */
    match /users/{userId} {
      allow get: if isOwner(userId);
      allow list: if false;
      allow create: if isOwner(userId);
      allow update: if isExistingOwner(userId);
      allow delete: if isExistingOwner(userId);
    }

    /**
     * @description Manages bookings for a specific user, ensuring only the user can access their bookings.
     * @path /users/{userId}/bookings/{bookingId}
     * @allow (get, list, create, update, delete): User can manage their own bookings.
     * @deny: Other users cannot access or modify another user's bookings.
     * @principle Enforces document ownership for bookings within a user's collection.
     */
    match /users/{userId}/bookings/{bookingId} {
      allow get: if isOwner(userId);
      allow list: if isOwner(userId);
      allow create: if isOwner(userId) && request.resource.data.userId == userId;
      allow update: if isExistingOwner(userId) && request.resource.data.userId == resource.data.userId;
      allow delete: if isExistingOwner(userId);
    }

    // Helper functions
    function isSignedIn() {
      return request.auth != null;
    }

    function isOwner(userId) {
      return isSignedIn() && request.auth.uid == userId;
    }

    function isExistingOwner(userId) {
        return isOwner(userId) && resource != null;
    }
  }
}